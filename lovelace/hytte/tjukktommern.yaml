Ftitle: TJUKKTØMMERN
views:
  - !include oppholdsrom.yaml

  - title: Stue
    path: stue
    icon: mdi:sofa
    cards:
      - type: custom:mushroom-title-card
        title: STUE
      - type: vertical-stack
        cards:
          - type: custom:mushroom-title-card
            title: LYSSCENER & LYS
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:mushroom-template-card
                primary: Max
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.stue_max
              - type: custom:mushroom-template-card
                primary: Dag
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.stue_dag
              - type: custom:mushroom-template-card
                primary: Kveld
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.stue_dempet
              - type: custom:mushroom-template-card
                primary: Av
                icon: mdi:lightbulb-off
                icon_color: red

                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.stue_alt_av_duplisere

          - type: grid
            columns: 2
            square: false
            cards:
              - type: custom:mushroom-light-card
                entity: light.stue_leselampe_venstre
                show_brightness_control: false
                collapsible_controls: false
              - type: custom:mushroom-light-card
                entity: light.stue_leselampe_hoyre
                show_brightness_control: false
                collapsible_controls: false
              - type: custom:mushroom-light-card
                entity: light.led_stue_butterfly
                show_brightness_control: true
                collapsible_controls: false
              - type: custom:mushroom-light-card
                entity: light.stue_5x_spott
                show_brightness_control: true
                collapsible_controls: false
              - type: custom:mushroom-light-card
                entity: light.lampe_ved_ovn
                show_brightness_control: false
                collapsible_controls: false

  - title: Spisestue
    path: spisestue
    icon: mdi:silverware-fork-knife
    cards:
      - type: custom:mushroom-title-card
        title: SPISESTUE
      - type: vertical-stack
        cards:
          - type: custom:mushroom-title-card
            title: LYSSCENER & LYS
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:mushroom-template-card
                primary: Max
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.spisestue_max
              - type: custom:mushroom-template-card
                primary: Dag
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.spisestue_dag
              - type: custom:mushroom-template-card
                primary: Kveld
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.spisestue_dempet
              - type: custom:mushroom-template-card
                primary: Av
                icon: mdi:lightbulb-off
                icon_color: red

                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.spisestue_av

          - type: grid
            columns: 1
            square: false
            cards:
              - type: custom:auto-entities
                card:
                  type: grid
                  columns: 2
                  square: false
                card_param: cards
                filter:
                  include:
                    - area: Spisestue
                      domain: light
                      options:
                        type: custom:mushroom-light-card
                        show_brightness_control: true
                show_empty: false

  - title: Kjøkken
    path: kjokken
    icon: mdi:countertop-outline
    cards:
      - type: custom:mushroom-title-card
        title: KJØKKEN
      - type: vertical-stack
        cards:
          - type: custom:mushroom-title-card
            title: LYSSCENER & LYS
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:mushroom-template-card
                primary: Max
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.kjokken_max
              - type: custom:mushroom-template-card
                primary: Dag
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.kjokken_dag
              - type: custom:mushroom-template-card
                primary: Kveld
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.kjokken_dempet
              - type: custom:mushroom-template-card
                primary: Av
                icon: mdi:lightbulb-off
                icon_color: red
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.kjokken_av

      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Kjøkken
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: true
        show_empty: false
  - title: Bad
    path: bad
    icon: mdi:shower
    cards:
      - type: custom:mushroom-title-card
        title: BAD
      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Bad
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: true
            - area: Bad
              domain: switch
              options:
                type: custom:mushroom-entity-card
                layout: horizontal
                secondary_info: none
                icon: mdi:fan
        show_empty: false
  - title: Soverom 1
    path: soverom_1
    icon: mdi:bed-king
    cards:
      - type: custom:mushroom-title-card
        title: Soverom 1
      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Soverom 1
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: true
        show_empty: false
  - title: Soverom 2
    path: soverom_2
    icon: mdi:bed-double
    cards:
      - type: custom:mushroom-title-card
        title: Soverom 2
      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Soverom 2
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: true
        show_empty: false
  - title: Soverom 3
    path: soverom_3
    icon: mdi:bed-single
    cards:
      - type: custom:mushroom-title-card
        title: Soverom 3
      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Soverom 3
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: true
        show_empty: false
  - title: Vaskerom
    path: vaskerom
    icon: mdi:washing-machine
    cards:
      - type: custom:mushroom-title-card
        title: Vaskerom
      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Vaskerom
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: true
        show_empty: false
  - title: Gang
    path: gang
    icon: mdi:walk
    cards:
      - type: custom:mushroom-title-card
        title: Gang
      - type: vertical-stack
        cards:
          - type: custom:mushroom-title-card
            title: LYSSCENER & LYS
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:mushroom-template-card
                primary: Max
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.gang_max
              - type: custom:mushroom-template-card
                primary: Dag
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.gang_dag
              - type: custom:mushroom-template-card
                primary: Kveld
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.gang_dempet
              - type: custom:mushroom-template-card
                primary: Av
                icon: mdi:lightbulb-off
                icon_color: red
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.gang_av

      - type: grid
        columns: 2
        square: false
        cards:
          - type: custom:mushroom-light-card
            entity: light.dimmer_gang_1_dimmeaktuator
            name: Taklys oppe
            show_brightness_control: true
            collapsible_controls: false
          - type: custom:mushroom-light-card
            entity: light.dimmer_gang_2_dimmeaktuator
            name: Taklys nede
            show_brightness_control: true
            collapsible_controls: false
          - type: custom:mushroom-light-card
            entity: light.maleribelysning
            name: Maleribelysning
            show_brightness_control: false
            collapsible_controls: false

  - title: Vindfang
    path: vindfang
    icon: mdi:hanger
    cards:
      - type: custom:mushroom-title-card
        title: Vindfang
      - type: vertical-stack
        cards:
          - type: custom:mushroom-title-card
            title: LYSSCENER & LYS
          - type: grid
            columns: 3
            square: false
            cards:
              - type: custom:mushroom-template-card
                primary: Max
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.vindfang_max
              - type: custom:mushroom-template-card
                primary: Dag
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.vindfang_dag
              - type: custom:mushroom-template-card
                primary: Kveld
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.vindfang_dempet
              - type: custom:mushroom-template-card
                primary: Av
                icon: mdi:lightbulb-off
                icon_color: red
                tap_action:
                  action: call-service
                  service: scene.turn_on
                  target:
                    entity_id: scene.vindfang_av

      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Vindfang
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: true

  - title: Bod
    path: bod
    icon: mdi:door-closed
    cards:
      - type: custom:mushroom-title-card
        title: Bod
      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Bod
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: false
                options:
        # KLIMA
      - type: custom:mushroom-title-card
        title: Klima
      - type: sensor
        entity: sensor.bod_temperaturmaler_temperature
        name: Bod temperatur
        graph: line # viser liten graf
        detail: 1 # grovere oppløsning (sparsom)
        hours_to_show: 24 # justér (f.eks. 48/72)
        unit: "°C" # valgfritt, hvis ikke allerede satt

        show_empty: false
  - title: Utendørs
    path: utendørs
    icon: mdi:sun-snowflake-variant
    cards:
      - type: custom:mushroom-title-card
        title: Utendørs
      - type: custom:auto-entities
        card:
          type: grid
          columns: 2
          square: false
        card_param: cards
        filter:
          include:
            - area: Utendørs
              domain: light
              options:
                type: custom:mushroom-light-card
                show_brightness_control: false
            - area: Utendørs
              domain: switch
              options:
                type: custom:mushroom-light-card
                show_brightness_control: false
                icon: mdi:lightbulb
                #layout: vertical
                #tap_action:
                #  action: toggle
        show_empty: false

  # Varmepumpestyring
  - title: Varmepumpestyring
    path: varmepumpestyring
    icon: mdi:heat-pump-outline
    visible:
      - user: f0d7a7b897f448c0acf93cabb356c822
    cards:
      - type: custom:mushroom-title-card
        title: Varmepumpestyring

      - type: vertical-stack
        cards:
          - type: entities
            title: Parametre
            entities:
              - input_number.stue_onsket_temp
              - input_number.stue_heat_bias_base
              - input_number.stue_heat_bias_gain
              - input_number.stue_ff_base_a
              - input_number.stue_ff_slope_b
              - input_number.stue_ff_threshold
              - input_number.stue_min_setpunkt
              - input_number.stue_max_setpunkt

          - type: custom:mushroom-title-card
            title: Stue varmepumpe – overvåkning

          - type: custom:mushroom-chips-card
            chips:
              - type: entity
                entity: climate.daikinap86694
                name: Daikin
              - type: entity
                entity: input_boolean.stue_klima_hold
                name: HOLD
                content_info: none
              - type: entity
                entity: timer.stue_cooldown
                name: Cooldown
                content_info: state
              - type: entity
                entity: sensor.stue_hp_deficit
                name: Underskudd

          - type: horizontal-stack
            cards:
              - type: custom:mushroom-template-card
                primary: Ønsket
                secondary: '{{ states("input_number.stue_onsket_temp") }} °C'
                icon: mdi:thermometer
                layout: vertical
              - type: custom:mushroom-template-card
                primary: Rom
                secondary: '{{ states("sensor.stue_temperatur_virtuell") }} °C'
                icon: mdi:home-thermometer-outline
                layout: vertical
              - type: custom:mushroom-template-card
                primary: Mål (eff)
                secondary: '{{ states("sensor.stue_hp_target_eff") }} °C'
                icon: mdi:target-variant
                layout: vertical
              - type: custom:mushroom-template-card
                primary: Daikin sett
                secondary: '{{ state_attr("climate.daikinap86694","temperature") | default("—") }} °C'
                icon: mdi:heat-pump
                layout: vertical
              - type: custom:mushroom-template-card
                primary: HP-aksjon
                secondary: '{{ state_attr("climate.daikinap86694","hvac_action") | default("—") }}'
                icon: mdi:run-fast
                layout: vertical

          - type: entities
            title: Status
            entities:
              - entity: sensor.stue_hp_target_raw
                name: Mål (rå)
              - entity: sensor.stue_hp_target_eff
                name: Mål (effektiv)
              - type: attribute
                entity: climate.daikinap86694
                attribute: temperature
                name: Daikin settpunkt (attr)
                unit: °C
              - type: attribute
                entity: climate.daikinap86694
                attribute: current_temperature
                name: Daikin målt (attr)
                unit: °C
              - type: attribute
                entity: climate.daikinap86694
                attribute: hvac_action
                name: HP-aksjon (attr)
              - entity: input_number.stue_last_cmd_set
                name: Sist sendt settpunkt
              - entity: input_boolean.stue_klima_hold
                name: HOLD (pause regulering)
              - entity: timer.stue_cooldown
                name: Cooldown

          - type: history-graph
            title: Temperaturer og mål (24t)
            hours_to_show: 24
            refresh_interval: 60
            entities:
              - entity: sensor.stue_temperatur_virtuell
                name: Rom
              - entity: input_number.stue_onsket_temp
                name: Ønsket
              - entity: sensor.stue_hp_target_eff
                name: Mål (eff)
              - entity: input_number.stue_last_cmd_set
                name: Sist sendt

          - type: history-graph
            title: Ute og underskudd (24t)
            hours_to_show: 24
            refresh_interval: 60
            entities:
              - entity: sensor.ute_temperatur_virtuell
                name: Ute
              - entity: sensor.stue_hp_deficit
                name: Underskudd

          - type: logbook
            title: Hendelser (seneste 12t)
            hours_to_show: 12
            entities:
              - climate.daikinap86694
              - script.stue_hp_apply_setpoint
              - automation.stue_hp_tracking

              # # --- Graf: inne vs beregnet setpunkt ---
              # - type: custom:mini-graph-card
              #   name: Temp vs setpunkt (24t)
              #   hours_to_show: 24
              #   points_per_hour: 6
              #   line_width: 2
              #   show:
              #     state: false
              #     legend: true
              #     labels: false
              #   entities:
              #     - entity: sensor.stue_temperatur_virtuell
              #       name: Inne
              #     - entity: sensor.stue_target_pumpesettpunkt
              #       name: Beregnet setpkt
              #       show_points: false

              # # --- Hovedstatus og styring ---
              # - type: entities
              #   entities:
              #     - input_number.stue_onsket_temp
              #     - entity: sensor.stue_temperatur_virtuell
              #       name: Målt inne (virtuell)
              #     - entity: sensor.ute_temperatur_virtuell
              #       name: Ute (virtuell)
              #     - entity: sensor.stue_target_pumpesettpunkt
              #       name: Beregnet setpunkt
              #     - entity: climate.daikinap86694
              #       name: Daikin
              #     - input_boolean.stue_klima_hold

              #     # --- D-ledd: diagnostikk ---
              #     - type: section
              #       label: D-ledd
              #     - entity: sensor.stue_temp_stigning_slow
              #       name: dT/dt (°C/min) slow
              #     - entity: sensor.stue_temp_stigning_fast
              #       name: dT/dt (°C/min) fast
              #     - entity: sensor.stue_d_bidrag
              #       name: D-bidrag (°C)

              #     # --- I-ledd: diagnostikk (NY) ---
              #     - type: section
              #       label: I-ledd
              #     - entity: input_number.stue_i_term
              #       name: I-term (°C)

              #     - entity: sensor.stue_temperaturfeil
              #       name: Feil (SP - T) (°C)

              # # --- Tuningparametre ---
              # - type: entities
              #   title: Tuning – P & feed-forward
              #   entities:
              #     - input_number.stue_base_offset_a
              #     - input_number.stue_kulde_slope_b
              #     - input_number.stue_kulde_terskel
              #     - input_number.stue_kp
              #     - input_number.stue_min_setpunkt
              #     - input_number.stue_max_setpunkt
              #     - input_number.stue_setpunkt_endringsgrense

              # # --- Tuning – D-ledd ---
              # - type: entities
              #   title: Tuning – D-ledd
              #   entities:
              #     - input_number.stue_kd
              #     - input_number.stue_deriv_threshold
              #     - input_number.stue_deriv_cap

              # # --- Tuning – I-ledd (NY) ---
              # - type: entities
              #   title: Tuning – I-ledd
              #   entities:
              #     - entity: input_number.stue_ki
              #       name: Ki (°C/(°C·min))
              #     - entity: input_number.stue_i_leak
              #       name: I-lekkasje pr. steg
              #     - entity: input_number.stue_i_cap
              #       name: Maks |I-bidrag| (°C)
              #     - entity: input_number.stue_i_term
              #       name: I-term (nå) (°C)

              # - type: vertical-stack
              #   cards:
              #     # --- Graf: inne vs beregnet setpunkt ---
              #     - type: custom:mini-graph-card
              #       name: Temp vs setpunkt (24t)
              #       hours_to_show: 24
              #       points_per_hour: 6
              #       line_width: 2
              #       show:
              #         state: false
              #         legend: true
              #         labels: false
              #       entities:
              #         - entity: sensor.stue_temperatur_virtuell
              #           name: Inne
              #         - entity: sensor.
              #           name: Beregnet setpkt
              #           show_points: false

              #     # --- Graf: dT/dt og D-bidrag ---
              #     - type: custom:mini-graph-card
              #       name: dT/dt & D (12t)
              #       hours_to_show: 12
              #       points_per_hour: 6
              #       line_width: 2
              #       show:
              #         state: false
              #         legend: true
              #         labels: false
              #       entities:
              #         - entity: sensor.stue_temp_stigning
              #           name: dT/dt (°C/min)
              #         - entity: sensor.stue_d_bidrag
              #           name: D-bidrag (°C)

              #     # --- Flis: live D-ledd ---
              #     - type: custom:mushroom-template-card
              #       primary: >
              #         {% set d = states('sensor.stue_d_bidrag')|float(0) %}
              #         D-ledd {{ d|round(2) }} °C
              #       secondary: >
              #         dT/dt: {{ states('sensor.stue_temp_stigning') }} °C/min
              #       icon: >
              #         {% set d = states('sensor.stue_d_bidrag')|float(0) %}
              #         {% if d|abs > 0 %}mdi:sigma{% else %}mdi:sigma-lower{% endif %}
              #       icon_color: >
              #         {% set d = states('sensor.stue_d_bidrag')|float(0) %}
              #         {% if d > 0 %}green{% elif d < 0 %}red{% else %}grey{% endif %}
              #       fill_container: false

              #     # --- Ekstra rad: I-term & feil (NY) ---
              #     - type: custom:mini-graph-card
              #       name: I-term & Feil (24t)
              #       hours_to_show: 24
              #       points_per_hour: 6
              #       line_width: 2
              #       show:
              #         state: false
              #         legend: true
              #         labels: false
              #       entities:
              #         - entity: input_number.stue_i_term
              #           name: I-term (°C)
              #         - entity: sensor.stue_temperaturfeil
              #           name: Feil (°C)
